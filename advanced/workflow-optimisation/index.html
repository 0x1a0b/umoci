<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.29" />
    <meta name="description" content="Documentation for umoci -- a tool for modifying OCI images.">
<meta name="author" content="Aleksa Sarai">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />

    <title>Workflow Optimistaion :: umoci</title>
    
    
    <link href="/css/nucleus.css?1508926413" rel="stylesheet">
    <link href="/css/font-awesome.min.css?1508926413" rel="stylesheet">
    <link href="/css/hybrid.css?1508926413" rel="stylesheet">
    <link href="/css/featherlight.min.css?1508926413" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1508926413" rel="stylesheet">
    <link href="/css/auto-complete.css?1508926413" rel="stylesheet">
    <link href="/css/theme.css?1508926413" rel="stylesheet">
    <link href="/css/hugo-theme.css?1508926413" rel="stylesheet">
    
      <link href="/css/theme-green.css?1508926413" rel="stylesheet">
    

    <script src="/js/jquery-2.x.min.js?1508926413"></script>
    
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{ 
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/advanced/workflow-optimisation/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="/"><strong style='color: white'>umoci</strong></a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1508926413"></script>
<script type="text/javascript" src="/js/auto-complete.js?1508926413"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/umo.ci\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1508926413"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/quick-start/" title="Basics" class="dd-item 
        
        
        
        ">
      <a href="/quick-start/">
          Basics
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/quick-start/getting-an-image/" title="Getting an Image" class="dd-item ">
        <a href="/quick-start/getting-an-image/">
        Getting an Image
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/quick-start/workflow/" title="Workflow" class="dd-item ">
        <a href="/quick-start/workflow/">
        Workflow
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/quick-start/creating-an-image/" title="Creating an Image" class="dd-item ">
        <a href="/quick-start/creating-an-image/">
        Creating an Image
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/quick-start/garbage-collection/" title="Garbage Collection" class="dd-item ">
        <a href="/quick-start/garbage-collection/">
        Garbage Collection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/quick-start/rootless/" title="Rootless Containers" class="dd-item ">
        <a href="/quick-start/rootless/">
        Rootless Containers
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/advanced/" title="Advanced" class="dd-item 
        parent
        
        
        ">
      <a href="/advanced/">
          Advanced
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/advanced/workflow-optimisation/" title="Workflow Optimistaion" class="dd-item active">
        <a href="/advanced/workflow-optimisation/">
        Workflow Optimistaion
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/reference/" title="Reference" class="dd-item 
        
        
        
        ">
      <a href="/reference/">
          Reference
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/reference/roadmap/" title="Roadmap" class="dd-item ">
        <a href="/reference/roadmap/">
        Roadmap
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/architecture/" title="Architecture" class="dd-item ">
        <a href="/reference/architecture/">
        Architecture
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/security/" title="Security Considerations" class="dd-item ">
        <a href="/reference/security/">
        Security Considerations
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li class="" role=""> 
                  <a class="padding" href="https://github.com/openSUSE/umoci"><i class='fa fa-git'></i> Source Code</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fa fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable sticky-parent">
              
              <div class="sticky-spacer">
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fa fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
                  
                  <span class="links">
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Home</a> > <a href='/advanced/'>Advanced</a> > Workflow Optimistaion
          
         
          
         
          
           
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#refresh-bundle"><code>--refresh-bundle</code></a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Workflow Optimistaion</h1>
          

        




<p>One of the first things that a user of umoci may notice is that certain
operations can be quite expensive. Most notable, unpack and repack operations
require either scanning through each layer archive of an image, or scanning
through the filesystem. Both operations require quite a bit of disk IO, and can
take a while. Fedora images are known to be quite large, and can take several
seconds to operate on.</p>

<pre><code class="language-text">% time umoci unpack --image fedora:26 bundle
umoci unpack --image fedora:26 bundle  8.43s user 1.68s system 105% cpu 9.562 total
% time umoci repack --image fedora:26-old bundle
umoci repack --image fedora:26 bundle  3.62s user 0.43s system 115% cpu 3.520 total
% find bundle/rootfs -type f -exec touch {} \;
% time umoci repack --image fedora:26-new bundle
umoci repack --image fedora:26-new bundle  32.03s user 4.50s system 112% cpu 32.559 total
</code></pre>

<p>While it is not currently possible to optimise or parallelise the above
operations individually (due to the structure of the layer archives), it is
possible to optimise your workflows in certain situations. These workflow tips
effectively revolve around reducing the amount of extractions that are
performed.</p>

<h3 id="refresh-bundle"><code>--refresh-bundle</code></h3>

<div class="notices tip" ><p>Note that while this functionality <a
href="https://github.com/openSUSE/umoci/pull/201">has been merged</a>, it has
not yet been released in a version of umoci.</p>
</div>


<p>A very common workflow when building a series of layers in an image is that,
since you want to place different files in different layers of the image, you
have to do something like the following:</p>

<pre><code class="language-text">% umoci unpack --image image_build_XYZ:wip bundle_a
% ./some_build_process_1 ./bundle_a
% umoci repack --image image_build_XYZ:wip bundle_a
% umoci unpack --image image_build_XYZ:wip bundle_b
% ./some_build_process_2 ./bundle_b
% umoci repack --image image_build_XYZ:wip bundle_b
% umoci unpack --image image_build_XYZ:wip bundle_c
% ./some_build_process_3 ./bundle_c
% umoci repack --image image_build_XYZ:wip bundle_c
% umoci tag --image image_build_XYZ:wip final
</code></pre>

<p>The above usage, while correct, is not very efficient. Each layer that is
created requires us to to do an unpack of the entire <code>image_build_XYZ:wip</code>
image before we can do anything. By noting that the root filesystem contained
in <code>bundle_a</code> after we&rsquo;ve made our changes is effectively the same as the root
filesystem that we extract into <code>bundle_b</code> (and since we already have
<code>bundle_a</code> we don&rsquo;t have to extract it), we can conclude that using <code>bundle_a</code>
is probably going to be more efficient. However, you cannot just do this the
&ldquo;intuitive way&rdquo;:</p>

<pre><code class="language-text">% umoci unpack --image image_build_XYZ:wip bundle_a
% ./some_build_process_1 ./bundle_a
% umoci repack --image image_build_XYZ:wip bundle_a
% ./some_build_process_2 ./bundle_a
% umoci repack --image image_build_XYZ:wip bundle_a
% ./some_build_process_3 ./bundle_a
% umoci repack --image image_build_XYZ:wip bundle_a
% umoci tag --image image_build_XYZ:wip final
</code></pre>

<p>Because the metadata stored in <code>bundle_a</code> includes information about what image
the bundle was based on (this is used when creating the modified image
metadata). Thus, the above usage will <em>not</em> result in multiple layers being
created, and the usage is roughly identical to the following:</p>

<pre><code class="language-text">% umoci unpack --image image_build_XYZ:wip bundle_a
% ./some_build_process_1 ./bundle_a
% ./some_build_process_2 ./bundle_a
% ./some_build_process_3 ./bundle_a
% umoci repack --image image_build_XYZ:wip bundle_a
% umoci tag --image image_build_XYZ:wip final
</code></pre>

<p>Do not dispair however, there is a flag just for you! With <code>--refresh-bundle</code>
it is possible to preform the above operations without needing to do any extra
unpack operations.</p>

<pre><code class="language-text">% umoci unpack --image image_build_XYZ:wip bundle_a
% ./some_build_process_1 ./bundle_a
% umoci repack --refresh-bundle --image image_build_XYZ:wip bundle_a
% ./some_build_process_2 ./bundle_a
% umoci repack --refresh-bundle --image image_build_XYZ:wip bundle_a
% ./some_build_process_3 ./bundle_a
% umoci repack --refresh-bundle --image image_build_XYZ:wip bundle_a
% umoci tag --image image_build_XYZ:wip final
</code></pre>

<p>Internally, <code>--refresh-bundle</code> is modifying the few metadata files inside
<code>bundle_a</code> so that future repack invocations modify the new image created by
the previous repack operation rather than basing it on the original unpacked
image. Therefore the cost of <code>--refresh-bundle</code> is constant, and is actually
<strong>much</strong> smaller than the cost of doing additional unpack operations.</p>


<footer class=" footline" >
	
</footer>


        
        </div> 
      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


        
            <a class="nav nav-prev" href="/advanced/" title="Advanced"> <i class="fa fa-chevron-left"></i></a>
        
        
            <a class="nav nav-next" href="/reference/" title="Reference" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
        
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1508926413"></script>
    <script src="/js/perfect-scrollbar.min.js?1508926413"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1508926413"></script>
    <script src="/js/jquery.sticky-kit.min.js?1508926413"></script>
    <script src="/js/featherlight.min.js?1508926413"></script>
    <script src="/js/html5shiv-printshiv.min.js?1508926413"></script>
    <script src="/js/highlight.pack.js?1508926413"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1508926413"></script>
    <script src="/js/learn.js?1508926413"></script>
    <script src="/js/hugo-learn.js?1508926413"></script>

    <link href="/mermaid/mermaid.css?1508926413" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1508926413"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

